# MySQL é”æœºåˆ¶

> é”æ˜¯æ•°æ®åº“å¹¶å‘æŽ§åˆ¶çš„æ ¸å¿ƒï¼Œç†è§£é”æœºåˆ¶æ˜¯æŽŒæ¡ MySQL çš„å…³é”®ã€‚

## ðŸ“š ç›®å½•

- [é”çš„åŸºæœ¬æ¦‚å¿µ](#é”çš„åŸºæœ¬æ¦‚å¿µ)
- [é”çš„åˆ†ç±»](#é”çš„åˆ†ç±»)
- [InnoDB è¡Œé”è¯¦è§£](#innodb-è¡Œé”è¯¦è§£)
- [åŠ é”è§„åˆ™åˆ†æž](#åŠ é”è§„åˆ™åˆ†æž)
- [æ­»é”](#æ­»é”)
- [é”çš„ç›‘æŽ§ä¸Žè¯Šæ–­](#é”çš„ç›‘æŽ§ä¸Žè¯Šæ–­)
- [é¢è¯•é«˜é¢‘é—®é¢˜](#é¢è¯•é«˜é¢‘é—®é¢˜)

---

## é”çš„åŸºæœ¬æ¦‚å¿µ

### ä»€ä¹ˆæ˜¯é”ï¼Ÿ

é”æ˜¯ç”¨æ¥ç®¡ç†å¯¹å…±äº«èµ„æºçš„å¹¶å‘è®¿é—®çš„ä¸€ç§æœºåˆ¶ã€‚åœ¨æ•°æ®åº“ä¸­ï¼Œé”ç”¨äºŽï¼š
- **ä¿è¯æ•°æ®ä¸€è‡´æ€§**ï¼šé˜²æ­¢å¤šä¸ªäº‹åŠ¡åŒæ—¶ä¿®æ”¹åŒä¸€æ•°æ®
- **å®žçŽ°éš”ç¦»æ€§**ï¼šæŽ§åˆ¶äº‹åŠ¡ä¹‹é—´çš„å¯è§æ€§
- **åè°ƒå¹¶å‘è®¿é—®**ï¼šåœ¨å¹¶å‘å’Œä¸€è‡´æ€§ä¹‹é—´å–å¾—å¹³è¡¡

### ä¸ºä»€ä¹ˆéœ€è¦é”ï¼Ÿ

```sql
-- åœºæ™¯ï¼šä¸¤ä¸ªäº‹åŠ¡åŒæ—¶ç»™è´¦æˆ·åŠ  100 å…ƒ
-- åˆå§‹ä½™é¢ï¼š1000 å…ƒ

-- äº‹åŠ¡ A                        äº‹åŠ¡ B
BEGIN;                           BEGIN;
SELECT balance FROM account      
WHERE id = 1;  -- è¯»åˆ° 1000
                                 SELECT balance FROM account 
                                 WHERE id = 1;  -- è¯»åˆ° 1000
UPDATE account SET balance = 1100
WHERE id = 1;  -- 1000 + 100
                                 UPDATE account SET balance = 1100
                                 WHERE id = 1;  -- 1000 + 100
COMMIT;                          COMMIT;

-- ç»“æžœï¼šä½™é¢æ˜¯ 1100ï¼Œè€Œä¸æ˜¯ 1200ï¼ï¼ˆä¸¢å¤±æ›´æ–°ï¼‰
```

**ä½¿ç”¨é”åŽ**ï¼š
```sql
-- äº‹åŠ¡ A                              äº‹åŠ¡ B
BEGIN;                                 BEGIN;
SELECT balance FROM account 
WHERE id = 1 FOR UPDATE;  -- åŠ  X é”
-- è¯»åˆ° 1000
                                       SELECT balance FROM account 
                                       WHERE id = 1 FOR UPDATE;  
                                       -- é˜»å¡žï¼Œç­‰å¾…äº‹åŠ¡ A é‡Šæ”¾é”
UPDATE account SET balance = 1100;
COMMIT;  -- é‡Šæ”¾é”
                                       -- èŽ·å¾—é”ï¼Œè¯»åˆ° 1100
                                       UPDATE account SET balance = 1200;
                                       COMMIT;

-- ç»“æžœï¼šä½™é¢æ˜¯ 1200 âœ…
```

---

## é”çš„åˆ†ç±»

MySQL çš„é”å¯ä»¥ä»Žä¸‰ä¸ªç»´åº¦åˆ†ç±»ï¼š

### 1. æŒ‰é”çš„ç²’åº¦åˆ†ç±»

```
å…¨å±€é”
  â””â”€ é”æ•´ä¸ªæ•°æ®åº“å®žä¾‹
è¡¨çº§é”
  â”œâ”€ è¡¨é”ï¼ˆTable Lockï¼‰
  â”œâ”€ å…ƒæ•°æ®é”ï¼ˆMDLï¼‰
  â”œâ”€ æ„å‘é”ï¼ˆIntention Lockï¼‰
  â””â”€ AUTO-INC é”
è¡Œçº§é”ï¼ˆInnoDBï¼‰
  â”œâ”€ è®°å½•é”ï¼ˆRecord Lockï¼‰
  â”œâ”€ é—´éš™é”ï¼ˆGap Lockï¼‰
  â”œâ”€ ä¸´é”®é”ï¼ˆNext-Key Lockï¼‰
  â””â”€ æ’å…¥æ„å‘é”ï¼ˆInsert Intention Lockï¼‰
```

#### 1.1 å…¨å±€é”ï¼ˆGlobal Lockï¼‰

**åŠ é”æ–¹å¼**ï¼š
```sql
FLUSH TABLES WITH READ LOCK;
```

**ç‰¹ç‚¹**ï¼š
- é”å®šæ•´ä¸ªæ•°æ®åº“å®žä¾‹
- æ‰€æœ‰è¡¨éƒ½å˜æˆåªè¯»
- å…¶ä»–çº¿ç¨‹çš„å†™æ“ä½œã€DDL æ“ä½œéƒ½ä¼šè¢«é˜»å¡ž

**ä½¿ç”¨åœºæ™¯**ï¼š
- å…¨åº“é€»è¾‘å¤‡ä»½ï¼ˆmysqldumpï¼‰
- ä¸æŽ¨èåœ¨ç”Ÿäº§çŽ¯å¢ƒä½¿ç”¨

**æ›´å¥½çš„æ›¿ä»£æ–¹æ¡ˆ**ï¼š
```sql
-- ä½¿ç”¨ mysqldump çš„ --single-transaction å‚æ•°
-- åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œåˆ©ç”¨ MVCC å®žçŽ°ä¸€è‡´æ€§è¯»
mysqldump --single-transaction --master-data=2 database > backup.sql
```

#### 1.2 è¡¨çº§é”

##### 1.2.1 è¡¨é”ï¼ˆTable Lockï¼‰

**åŠ é”æ–¹å¼**ï¼š
```sql
-- è¯»é”ï¼ˆå…±äº«é”ï¼‰
LOCK TABLES table_name READ;

-- å†™é”ï¼ˆæŽ’ä»–é”ï¼‰
LOCK TABLES table_name WRITE;

-- é‡Šæ”¾é”
UNLOCK TABLES;
```

**è¯»é”ï¼ˆå…±äº«é”ï¼‰ç‰¹ç‚¹**ï¼š
- å½“å‰ä¼šè¯ï¼šå¯ä»¥è¯»ï¼Œä¸èƒ½å†™
- å…¶ä»–ä¼šè¯ï¼šå¯ä»¥è¯»ï¼Œå†™ä¼šé˜»å¡ž

**å†™é”ï¼ˆæŽ’ä»–é”ï¼‰ç‰¹ç‚¹**ï¼š
- å½“å‰ä¼šè¯ï¼šå¯ä»¥è¯»å†™
- å…¶ä»–ä¼šè¯ï¼šè¯»å†™éƒ½ä¼šé˜»å¡ž

**é”å…¼å®¹æ€§çŸ©é˜µ**ï¼š

|  | è¯»é” | å†™é” |
|--|------|------|
| **è¯»é”** | âœ… å…¼å®¹ | âŒ äº’æ–¥ |
| **å†™é”** | âŒ äº’æ–¥ | âŒ äº’æ–¥ |

**ç¤ºä¾‹**ï¼š
```sql
-- ä¼šè¯ A
LOCK TABLES t READ;
SELECT * FROM t;  -- âœ… æˆåŠŸ
UPDATE t SET a=1; -- âŒ æŠ¥é”™ï¼šTable 't' was locked with a READ lock

-- ä¼šè¯ B
SELECT * FROM t;  -- âœ… æˆåŠŸï¼ˆè¯»ä¸é˜»å¡žï¼‰
UPDATE t SET a=1; -- â³ é˜»å¡žï¼ˆç­‰å¾…ä¼šè¯ A é‡Šæ”¾é”ï¼‰
```

##### 1.2.2 å…ƒæ•°æ®é”ï¼ˆMDLï¼ŒMetadata Lockï¼‰

**ç‰¹ç‚¹**ï¼š
- MySQL 5.5 å¼•å…¥
- **è‡ªåŠ¨åŠ é”**ï¼Œæ— éœ€æ˜¾å¼ä½¿ç”¨
- ä¿æŠ¤è¡¨ç»“æž„çš„ä¸€è‡´æ€§

**åŠ é”è§„åˆ™**ï¼š
```sql
-- DML æ“ä½œï¼ˆSELECTã€INSERTã€UPDATEã€DELETEï¼‰è‡ªåŠ¨åŠ  MDL è¯»é”
SELECT * FROM t;  -- åŠ  MDL è¯»é”

-- DDL æ“ä½œï¼ˆALTER TABLEã€DROP TABLEï¼‰è‡ªåŠ¨åŠ  MDL å†™é”
ALTER TABLE t ADD COLUMN c INT;  -- åŠ  MDL å†™é”
```

**MDL é”å…¼å®¹æ€§**ï¼š

|  | MDL è¯»é” | MDL å†™é” |
|--|----------|----------|
| **MDL è¯»é”** | âœ… å…¼å®¹ | âŒ äº’æ–¥ |
| **MDL å†™é”** | âŒ äº’æ–¥ | âŒ äº’æ–¥ |

**ç»å…¸é—®é¢˜ï¼šé•¿äº‹åŠ¡æŒæœ‰ MDL è¯»é”å¯¼è‡´ DDL é˜»å¡ž**

```sql
-- ä¼šè¯ Aï¼šé•¿äº‹åŠ¡
BEGIN;
SELECT * FROM t;  -- åŠ  MDL è¯»é”
-- ... æ‰§è¡Œäº†å¾ˆé•¿æ—¶é—´ï¼Œæ²¡æœ‰æäº¤

-- ä¼šè¯ Bï¼šDDL æ“ä½œ
ALTER TABLE t ADD COLUMN c INT;  -- â³ é˜»å¡žï¼ˆç­‰å¾… MDL å†™é”ï¼‰

-- ä¼šè¯ Cï¼šæ™®é€šæŸ¥è¯¢
SELECT * FROM t;  -- â³ ä¹Ÿè¢«é˜»å¡žäº†ï¼
```

**åŽŸå› **ï¼š
1. ä¼šè¯ A æŒæœ‰ MDL è¯»é”
2. ä¼šè¯ B çš„ DDL ç­‰å¾… MDL å†™é”ï¼ˆè¢« A é˜»å¡žï¼‰
3. ä¼šè¯ C çš„æŸ¥è¯¢ä¹Ÿè¦ç”³è¯· MDL è¯»é”ï¼Œä½†æŽ’åœ¨ B åŽé¢ï¼Œæ‰€ä»¥ä¹Ÿè¢«é˜»å¡ž

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. é¿å…é•¿äº‹åŠ¡
2. åœ¨ä¸šåŠ¡ä½Žå³°æœŸæ‰§è¡Œ DDL
3. ä½¿ç”¨ `ALTER TABLE ... NOWAIT` æˆ– `WAIT N`ï¼ˆMySQL 8.0.1+ï¼‰ï¼š
   ```sql
   ALTER TABLE t ADD COLUMN c INT, WAIT 10;  -- æœ€å¤šç­‰å¾… 10 ç§’
   ```

##### 1.2.3 æ„å‘é”ï¼ˆIntention Lockï¼‰

**ä½œç”¨**ï¼š
- è¡¨æ˜Žäº‹åŠ¡æƒ³è¦åœ¨è¡¨çš„æŸäº›è¡Œä¸ŠåŠ é”
- åè°ƒè¡¨é”å’Œè¡Œé”çš„å†²çª
- æé«˜åŠ è¡¨é”çš„æ•ˆçŽ‡

**ç±»åž‹**ï¼š
- **æ„å‘å…±äº«é”ï¼ˆISï¼‰**ï¼šè¡¨æ˜Žäº‹åŠ¡æƒ³è¦å¯¹æŸäº›è¡ŒåŠ å…±äº«é”
- **æ„å‘æŽ’ä»–é”ï¼ˆIXï¼‰**ï¼šè¡¨æ˜Žäº‹åŠ¡æƒ³è¦å¯¹æŸäº›è¡ŒåŠ æŽ’ä»–é”

**åŠ é”è§„åˆ™**ï¼š
```sql
-- åŠ è¡Œçº§å…±äº«é”å‰ï¼Œå…ˆåŠ è¡¨çº§æ„å‘å…±äº«é”
SELECT * FROM t WHERE id = 1 LOCK IN SHARE MODE;
-- è‡ªåŠ¨åŠ ï¼šè¡¨çº§ IS é” â†’ è¡Œçº§ S é”

-- åŠ è¡Œçº§æŽ’ä»–é”å‰ï¼Œå…ˆåŠ è¡¨çº§æ„å‘æŽ’ä»–é”
SELECT * FROM t WHERE id = 1 FOR UPDATE;
-- è‡ªåŠ¨åŠ ï¼šè¡¨çº§ IX é” â†’ è¡Œçº§ X é”
```

**ä¸ºä»€ä¹ˆéœ€è¦æ„å‘é”ï¼Ÿ**

**æ²¡æœ‰æ„å‘é”æ—¶**ï¼ŒåŠ è¡¨é”éœ€è¦ï¼š
```
1. éåŽ†æ‰€æœ‰è¡Œï¼Œæ£€æŸ¥æ˜¯å¦æœ‰è¡Œé”
2. å¦‚æžœæœ‰å†²çªçš„è¡Œé”ï¼Œåˆ™åŠ è¡¨é”å¤±è´¥
3. æ—¶é—´å¤æ‚åº¦ï¼šO(n)
```

**æœ‰æ„å‘é”æ—¶**ï¼ŒåŠ è¡¨é”åªéœ€ï¼š
```
1. æ£€æŸ¥è¡¨çº§æ„å‘é”
2. å¦‚æžœæœ‰å†²çªçš„æ„å‘é”ï¼Œåˆ™åŠ è¡¨é”å¤±è´¥
3. æ—¶é—´å¤æ‚åº¦ï¼šO(1)
```

**é”å…¼å®¹æ€§çŸ©é˜µ**ï¼š

|  | IS | IX | S | X |
|--|----|----|---|---|
| **IS** | âœ… | âœ… | âœ… | âŒ |
| **IX** | âœ… | âœ… | âŒ | âŒ |
| **S**  | âœ… | âŒ | âœ… | âŒ |
| **X**  | âŒ | âŒ | âŒ | âŒ |

**æ³¨æ„**ï¼šæ„å‘é”ä¹‹é—´å…¼å®¹ï¼Œä¸ä¼šäº’ç›¸é˜»å¡žã€‚

##### 1.2.4 AUTO-INC é”

**ä½œç”¨**ï¼šä¿è¯è‡ªå¢žä¸»é”®çš„è¿žç»­æ€§

**åŠ é”æœºåˆ¶**ï¼š
```sql
INSERT INTO t (name) VALUES ('Alice');
-- åœ¨æ’å…¥æ—¶ï¼Œè‡ªåŠ¨å¯¹ AUTO_INCREMENT åˆ—åŠ é”
```

**å‚æ•°æŽ§åˆ¶**ï¼š`innodb_autoinc_lock_mode`

- **0ï¼ˆtraditionalï¼‰**ï¼šä¼ ç»Ÿæ¨¡å¼
  - æ‰€æœ‰ INSERT éƒ½ç”¨è¡¨çº§ AUTO-INC é”
  - è¯­å¥æ‰§è¡Œå®Œæ‰é‡Šæ”¾
  - å¹¶å‘æ€§èƒ½å·®

- **1ï¼ˆconsecutiveï¼Œé»˜è®¤ï¼‰**ï¼šè¿žç»­æ¨¡å¼
  - ç®€å•æ’å…¥ï¼ˆINSERTï¼‰ï¼šä½¿ç”¨è½»é‡çº§äº’æ–¥é‡
  - æ‰¹é‡æ’å…¥ï¼ˆINSERT ... SELECTï¼‰ï¼šä½¿ç”¨è¡¨çº§é”
  - ä¿è¯è¿žç»­æ€§ï¼Œæ€§èƒ½è¾ƒå¥½

- **2ï¼ˆinterleavedï¼‰**ï¼šäº¤é”™æ¨¡å¼
  - æ‰€æœ‰ INSERT éƒ½ç”¨è½»é‡çº§äº’æ–¥é‡
  - ä¸ä¿è¯è¿žç»­æ€§ï¼ˆID å¯èƒ½æœ‰ç©ºæ´žï¼‰
  - å¹¶å‘æ€§èƒ½æœ€å¥½
  - **binlog å¿…é¡»æ˜¯ row æ ¼å¼**

### 2. æŒ‰é”çš„æ¨¡å¼åˆ†ç±»

#### 2.1 å…±äº«é”ï¼ˆShared Lockï¼ŒS é”ï¼‰

**ç‰¹ç‚¹**ï¼š
- ä¹Ÿå«**è¯»é”**
- å¤šä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰
- æŒæœ‰ S é”çš„äº‹åŠ¡å¯ä»¥è¯»æ•°æ®
- é˜»æ­¢å…¶ä»–äº‹åŠ¡èŽ·å¾— X é”

**åŠ é”æ–¹å¼**ï¼š
```sql
SELECT * FROM t WHERE id = 1 LOCK IN SHARE MODE;
-- MySQL 8.0+ æŽ¨èä½¿ç”¨ï¼š
SELECT * FROM t WHERE id = 1 FOR SHARE;
```

#### 2.2 æŽ’ä»–é”ï¼ˆExclusive Lockï¼ŒX é”ï¼‰

**ç‰¹ç‚¹**ï¼š
- ä¹Ÿå«**å†™é”**
- åªæœ‰ä¸€ä¸ªäº‹åŠ¡å¯ä»¥æŒæœ‰
- æŒæœ‰ X é”çš„äº‹åŠ¡å¯ä»¥è¯»å†™æ•°æ®
- é˜»æ­¢å…¶ä»–äº‹åŠ¡èŽ·å¾— S é”å’Œ X é”

**åŠ é”æ–¹å¼**ï¼š
```sql
-- æ˜¾å¼åŠ é”
SELECT * FROM t WHERE id = 1 FOR UPDATE;

-- éšå¼åŠ é”
UPDATE t SET a = 1 WHERE id = 1;
DELETE FROM t WHERE id = 1;
INSERT INTO t VALUES (...);
```

**é”å…¼å®¹æ€§**ï¼š

|  | S é” | X é” |
|--|------|------|
| **S é”** | âœ… å…¼å®¹ | âŒ äº’æ–¥ |
| **X é”** | âŒ äº’æ–¥ | âŒ äº’æ–¥ |

### 3. æŒ‰é”çš„ç®—æ³•åˆ†ç±»ï¼ˆInnoDB è¡Œé”ï¼‰

è¿™æ˜¯ MySQL é”æœºåˆ¶çš„**æ ¸å¿ƒ**ï¼Œä¹Ÿæ˜¯é¢è¯•çš„**é‡ç‚¹**ã€‚

#### 3.1 è®°å½•é”ï¼ˆRecord Lockï¼‰

**å®šä¹‰**ï¼šé”å®šå•ä¸ªç´¢å¼•è®°å½•ã€‚

**ç‰¹ç‚¹**ï¼š
- æ€»æ˜¯é”å®š**ç´¢å¼•è®°å½•**ï¼Œè€Œä¸æ˜¯æ•°æ®è¡Œæœ¬èº«
- å¦‚æžœè¡¨æ²¡æœ‰ç´¢å¼•ï¼ŒInnoDB ä¼šåˆ›å»ºéšè—çš„èšç°‡ç´¢å¼•

**ç¤ºä¾‹**ï¼š
```sql
-- è¡¨ç»“æž„
CREATE TABLE t (
  id INT PRIMARY KEY,
  a INT,
  b INT,
  KEY(a)
);

-- å”¯ä¸€ç´¢å¼•ç­‰å€¼æŸ¥è¯¢ï¼Œè®°å½•å­˜åœ¨
SELECT * FROM t WHERE id = 10 FOR UPDATE;
-- åŠ é”ï¼šid = 10 çš„è®°å½•é”ï¼ˆX é”ï¼‰
```

**åœ¨ EXPLAIN ä¸­çš„è¡¨çŽ°**ï¼š
```
type: const æˆ– eq_ref
```

#### 3.2 é—´éš™é”ï¼ˆGap Lockï¼‰

**å®šä¹‰**ï¼šé”å®šç´¢å¼•è®°å½•ä¹‹é—´çš„"é—´éš™"ï¼Œä½†ä¸åŒ…æ‹¬è®°å½•æœ¬èº«ã€‚

**ä½œç”¨**ï¼š
- é˜²æ­¢å…¶ä»–äº‹åŠ¡åœ¨é—´éš™ä¸­æ’å…¥æ•°æ®
- **é˜²æ­¢å¹»è¯»**çš„å…³é”®æœºåˆ¶

**ç‰¹ç‚¹**ï¼š
- åªåœ¨ **REPEATABLE READ** éš”ç¦»çº§åˆ«ä¸‹æœ‰æ•ˆ
- READ COMMITTED çº§åˆ«ä¸‹æ²¡æœ‰é—´éš™é”
- é—´éš™é”ä¹‹é—´**ä¸äº’æ–¥**ï¼ˆéƒ½æ˜¯ä¸ºäº†é˜²æ­¢æ’å…¥ï¼‰

**ç¤ºä¾‹**ï¼š
```sql
-- å‡è®¾è¡¨ t ä¸­æœ‰è®°å½•ï¼šid = 1, 5, 10

-- å”¯ä¸€ç´¢å¼•ç­‰å€¼æŸ¥è¯¢ï¼Œè®°å½•ä¸å­˜åœ¨
SELECT * FROM t WHERE id = 7 FOR UPDATE;
-- åŠ é”ï¼šé—´éš™é” (5, 10)ï¼Œä¸åŒ…æ‹¬ 5 å’Œ 10

-- æ­¤æ—¶å…¶ä»–äº‹åŠ¡ï¼š
INSERT INTO t VALUES (6, ...);  -- â³ é˜»å¡ž
INSERT INTO t VALUES (7, ...);  -- â³ é˜»å¡ž
INSERT INTO t VALUES (8, ...);  -- â³ é˜»å¡ž
INSERT INTO t VALUES (5, ...);  -- âœ… æˆåŠŸï¼ˆ5 ä¸åœ¨é—´éš™å†…ï¼‰
INSERT INTO t VALUES (10, ...); -- âœ… æˆåŠŸï¼ˆ10 ä¸åœ¨é—´éš™å†…ï¼‰
```

**é—´éš™é”ä¸äº’æ–¥çš„ä¾‹å­**ï¼š
```sql
-- ä¼šè¯ A
BEGIN;
SELECT * FROM t WHERE id = 7 FOR UPDATE;  -- åŠ é—´éš™é” (5, 10)

-- ä¼šè¯ B
BEGIN;
SELECT * FROM t WHERE id = 8 FOR UPDATE;  -- âœ… æˆåŠŸï¼ä¹ŸåŠ é—´éš™é” (5, 10)

-- å› ä¸ºä¸¤ä¸ªé—´éš™é”éƒ½æ˜¯ä¸ºäº†é˜²æ­¢æ’å…¥ï¼Œä¸å†²çª
```

#### 3.3 ä¸´é”®é”ï¼ˆNext-Key Lockï¼‰

**å®šä¹‰**ï¼šè®°å½•é” + é—´éš™é”ï¼Œé”å®šä¸€ä¸ªå·¦å¼€å³é—­åŒºé—´ `(a, b]`ã€‚

**ç‰¹ç‚¹**ï¼š
- è¿™æ˜¯ InnoDB çš„**é»˜è®¤è¡Œé”ç®—æ³•**
- REPEATABLE READ éš”ç¦»çº§åˆ«ä¸‹çš„æ ‡é…
- **å½»åº•è§£å†³å¹»è¯»é—®é¢˜**

**ç¤ºä¾‹**ï¼š
```sql
-- å‡è®¾è¡¨ t ä¸­æœ‰è®°å½•ï¼šid = 1, 5, 10, 15

-- èŒƒå›´æŸ¥è¯¢
SELECT * FROM t WHERE id >= 10 AND id < 15 FOR UPDATE;

-- åŠ é”ï¼š
-- 1. (5, 10] çš„ä¸´é”®é”
-- 2. (10, 15] çš„ä¸´é”®é”
-- æ³¨æ„ï¼š15 è¿™æ¡è®°å½•ä¹Ÿè¢«é”äº†ï¼ˆå³é—­åŒºé—´ï¼‰
```

**ä¸´é”®é”çš„ç»„æˆ**ï¼š
```
ä¸´é”®é” (5, 10] = é—´éš™é” (5, 10) + è®°å½•é” [10]
```

**ä¸ºä»€ä¹ˆæ˜¯å·¦å¼€å³é—­ï¼Ÿ**
- ä¸ºäº†é¿å…æ‰«ææ—¶çš„é‡å¤åŠ é”
- ç®€åŒ–åŠ é”é€»è¾‘

#### 3.4 æ’å…¥æ„å‘é”ï¼ˆInsert Intention Lockï¼‰

**å®šä¹‰**ï¼šä¸€ç§ç‰¹æ®Šçš„é—´éš™é”ï¼Œåœ¨æ’å…¥æ—¶åŠ çš„é”ã€‚

**ç‰¹ç‚¹**ï¼š
- æ’å…¥æ„å‘é”ä¹‹é—´**ä¸äº’æ–¥**
- ä½†ä¼šè¢«é—´éš™é”é˜»å¡ž

**ç¤ºä¾‹**ï¼š
```sql
-- ä¼šè¯ A
BEGIN;
SELECT * FROM t WHERE id > 5 AND id < 10 FOR UPDATE;
-- åŠ é”ï¼šé—´éš™é” (5, 10)

-- ä¼šè¯ B
BEGIN;
INSERT INTO t VALUES (7, ...);
-- 1. ç”³è¯·æ’å…¥æ„å‘é”ï¼ˆæƒ³åœ¨ (5, 10) æ’å…¥ï¼‰
-- 2. â³ è¢«ä¼šè¯ A çš„é—´éš™é”é˜»å¡ž

-- ä¼šè¯ C
BEGIN;
INSERT INTO t VALUES (8, ...);
-- 1. ç”³è¯·æ’å…¥æ„å‘é”ï¼ˆæƒ³åœ¨ (5, 10) æ’å…¥ï¼‰
-- 2. â³ è¢«ä¼šè¯ A çš„é—´éš™é”é˜»å¡ž
-- 3. ä½†ä¸ä¼šè¢«ä¼šè¯ B çš„æ’å…¥æ„å‘é”é˜»å¡ž
```

---

## InnoDB è¡Œé”è¯¦è§£

### è¡Œé”çš„æœ¬è´¨

**æ ¸å¿ƒåŽŸåˆ™**ï¼šInnoDB çš„è¡Œé”æ˜¯**åŠ åœ¨ç´¢å¼•ä¸Šçš„**ï¼Œè€Œä¸æ˜¯åŠ åœ¨æ•°æ®è¡Œä¸Šã€‚

```
æ²¡æœ‰ç´¢å¼• â†’ é”å…¨è¡¨
æœ‰ç´¢å¼•   â†’ é”ç´¢å¼•è®°å½•
```

### ä¸åŒç´¢å¼•ç±»åž‹çš„åŠ é”

#### 1. ä¸»é”®ç´¢å¼•ï¼ˆèšç°‡ç´¢å¼•ï¼‰

```sql
-- ç­‰å€¼æŸ¥è¯¢ï¼Œè®°å½•å­˜åœ¨
SELECT * FROM t WHERE id = 10 FOR UPDATE;
-- åŠ é”ï¼šid = 10 çš„è®°å½•é”

-- ç­‰å€¼æŸ¥è¯¢ï¼Œè®°å½•ä¸å­˜åœ¨
SELECT * FROM t WHERE id = 15 FOR UPDATE;
-- åŠ é”ï¼šé—´éš™é”ï¼Œä¾‹å¦‚ (10, 20)
```

#### 2. å”¯ä¸€ç´¢å¼•

```sql
-- ç­‰å€¼æŸ¥è¯¢ï¼Œè®°å½•å­˜åœ¨
SELECT * FROM t WHERE uniq_col = 'abc' FOR UPDATE;
-- åŠ é”ï¼š
-- 1. uniq_col = 'abc' çš„è®°å½•é”
-- 2. å¯¹åº”çš„ä¸»é”®è®°å½•é”ï¼ˆå¦‚æžœéœ€è¦å›žè¡¨ï¼‰

-- ç­‰å€¼æŸ¥è¯¢ï¼Œè®°å½•ä¸å­˜åœ¨
SELECT * FROM t WHERE uniq_col = 'xyz' FOR UPDATE;
-- åŠ é”ï¼šé—´éš™é”
```

#### 3. æ™®é€šç´¢å¼•

```sql
-- ç­‰å€¼æŸ¥è¯¢
SELECT * FROM t WHERE normal_col = 10 FOR UPDATE;
-- åŠ é”ï¼š
-- 1. normal_col = 10 çš„æ‰€æœ‰è®°å½•é”
-- 2. normal_col = 10 å‰åŽçš„é—´éš™é”
-- 3. å¯¹åº”çš„ä¸»é”®è®°å½•é”ï¼ˆå›žè¡¨ï¼‰

-- èŒƒå›´æŸ¥è¯¢
SELECT * FROM t WHERE normal_col >= 10 AND normal_col < 20 FOR UPDATE;
-- åŠ é”ï¼š
-- 1. [10, 20) èŒƒå›´å†…çš„ä¸´é”®é”
-- 2. å¯èƒ½è¿˜åŒ…æ‹¬ 20 ä¹‹åŽçš„é—´éš™é”
-- 3. å¯¹åº”çš„ä¸»é”®è®°å½•é”
```

#### 4. æ— ç´¢å¼•

```sql
-- æ— ç´¢å¼•æ¡ä»¶
SELECT * FROM t WHERE non_indexed_col = 10 FOR UPDATE;
-- åŠ é”ï¼šå…¨è¡¨æ‰«æï¼Œæ‰€æœ‰è®°å½•éƒ½åŠ é”ï¼ˆé€€åŒ–ä¸ºè¡¨é”ï¼‰
```

**ä¼˜åŒ–å»ºè®®**ï¼š
- âœ… å¿…é¡»ä¸º WHERE æ¡ä»¶çš„åˆ—å»ºç«‹ç´¢å¼•
- âœ… é¿å…å…¨è¡¨æ‰«æé”å…¨è¡¨

---

## åŠ é”è§„åˆ™åˆ†æž

è¿™æ˜¯é¢è¯•çš„**é‡ç‚¹**ï¼Œå¿…é¡»æŽŒæ¡ï¼

### åŠ é”è§„åˆ™æ€»ç»“

**ä¸¤ä¸ªåŽŸåˆ™**ï¼š
1. åŠ é”çš„åŸºæœ¬å•ä½æ˜¯ Next-Key Lockï¼ˆä¸´é”®é”ï¼‰
2. æŸ¥æ‰¾è¿‡ç¨‹ä¸­è®¿é—®åˆ°çš„å¯¹è±¡æ‰ä¼šåŠ é”

**ä¸¤ä¸ªä¼˜åŒ–**ï¼š
1. ç­‰å€¼æŸ¥è¯¢ï¼Œå¦‚æžœæ‰¾åˆ°äº†å”¯ä¸€è®°å½•ï¼ŒNext-Key Lock é€€åŒ–ä¸º Record Lock
2. ç­‰å€¼æŸ¥è¯¢ï¼Œæ²¡æœ‰æ‰¾åˆ°è®°å½•ï¼ŒNext-Key Lock é€€åŒ–ä¸º Gap Lock

**ä¸€ä¸ª bug**ï¼ˆMySQL 8.0 å·²ä¿®å¤ï¼‰ï¼š
- å”¯ä¸€ç´¢å¼•çš„èŒƒå›´æŸ¥è¯¢ä¼šè®¿é—®åˆ°ä¸æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå€¼ä¸ºæ­¢

### åœºæ™¯ 1ï¼šå”¯ä¸€ç´¢å¼•ç­‰å€¼æŸ¥è¯¢ï¼ˆè®°å½•å­˜åœ¨ï¼‰

```sql
-- è¡¨ç»“æž„å’Œæ•°æ®
CREATE TABLE t (
  id INT PRIMARY KEY,
  c INT,
  d INT,
  KEY(c)
) ENGINE=InnoDB;

INSERT INTO t VALUES 
(0, 0, 0), (5, 5, 5), (10, 10, 10), (15, 15, 15), (20, 20, 20), (25, 25, 25);

-- æŸ¥è¯¢
SELECT * FROM t WHERE id = 10 FOR UPDATE;
```

**åŠ é”åˆ†æž**ï¼š
1. æŸ¥è¯¢ä½¿ç”¨ä¸»é”®ç´¢å¼•
2. ç­‰å€¼æŸ¥è¯¢ï¼Œæ‰¾åˆ°äº† id = 10 çš„è®°å½•
3. **ä¼˜åŒ– 1**ï¼šNext-Key Lock é€€åŒ–ä¸º Record Lock

**åŠ é”ç»“æžœ**ï¼š
- ä¸»é”®ç´¢å¼•ï¼šid = 10 çš„è®°å½•é”ï¼ˆX é”ï¼‰

**éªŒè¯**ï¼š
```sql
-- ä¼šè¯ A
BEGIN;
SELECT * FROM t WHERE id = 10 FOR UPDATE;

-- ä¼šè¯ B
UPDATE t SET d = 100 WHERE id = 10;  -- â³ é˜»å¡ž
UPDATE t SET d = 100 WHERE id = 9;   -- âœ… æˆåŠŸ
UPDATE t SET d = 100 WHERE id = 11;  -- âœ… æˆåŠŸ
```

### åœºæ™¯ 2ï¼šå”¯ä¸€ç´¢å¼•ç­‰å€¼æŸ¥è¯¢ï¼ˆè®°å½•ä¸å­˜åœ¨ï¼‰

```sql
SELECT * FROM t WHERE id = 7 FOR UPDATE;
```

**åŠ é”åˆ†æž**ï¼š
1. æŸ¥è¯¢ä½¿ç”¨ä¸»é”®ç´¢å¼•
2. ç­‰å€¼æŸ¥è¯¢ï¼Œæ²¡æœ‰æ‰¾åˆ° id = 7 çš„è®°å½•
3. æ‰«æåˆ° id = 10ï¼ˆç¬¬ä¸€ä¸ªå¤§äºŽ 7 çš„è®°å½•ï¼‰
4. **ä¼˜åŒ– 2**ï¼šNext-Key Lock é€€åŒ–ä¸º Gap Lock

**åŠ é”ç»“æžœ**ï¼š
- ä¸»é”®ç´¢å¼•ï¼šé—´éš™é” (5, 10)

**éªŒè¯**ï¼š
```sql
-- ä¼šè¯ A
BEGIN;
SELECT * FROM t WHERE id = 7 FOR UPDATE;

-- ä¼šè¯ B
INSERT INTO t VALUES (6, 6, 6);   -- â³ é˜»å¡ž
INSERT INTO t VALUES (8, 8, 8);   -- â³ é˜»å¡ž
INSERT INTO t VALUES (5, 5, 5);   -- âœ… æˆåŠŸ
INSERT INTO t VALUES (10, 10, 10); -- âœ… æˆåŠŸ
UPDATE t SET d = 100 WHERE id = 10; -- âœ… æˆåŠŸï¼ˆè®°å½•é”ä¸å†²çªï¼‰
```

### åœºæ™¯ 3ï¼šå”¯ä¸€ç´¢å¼•èŒƒå›´æŸ¥è¯¢

```sql
SELECT * FROM t WHERE id >= 10 AND id < 15 FOR UPDATE;
```

**åŠ é”åˆ†æž**ï¼š
1. æŸ¥è¯¢ä½¿ç”¨ä¸»é”®ç´¢å¼•
2. èŒƒå›´æŸ¥è¯¢ï¼Œæ‰«æ id = 10, 15
3. å¯¹æ‰«æåˆ°çš„è®°å½•åŠ  Next-Key Lock

**åŠ é”ç»“æžœ**ï¼š
- ä¸»é”®ç´¢å¼•ï¼š
  - (5, 10] çš„ä¸´é”®é”
  - (10, 15] çš„ä¸´é”®é”

**éªŒè¯**ï¼š
```sql
-- ä¼šè¯ A
BEGIN;
SELECT * FROM t WHERE id >= 10 AND id < 15 FOR UPDATE;

-- ä¼šè¯ B
INSERT INTO t VALUES (8, 8, 8);   -- â³ é˜»å¡žï¼ˆé—´éš™é” (5, 10)ï¼‰
INSERT INTO t VALUES (12, 12, 12); -- â³ é˜»å¡žï¼ˆé—´éš™é” (10, 15)ï¼‰
UPDATE t SET d = 100 WHERE id = 10; -- â³ é˜»å¡žï¼ˆè®°å½•é”ï¼‰
UPDATE t SET d = 100 WHERE id = 15; -- â³ é˜»å¡žï¼ˆè®°å½•é”ï¼‰
UPDATE t SET d = 100 WHERE id = 20; -- âœ… æˆåŠŸ
```

### åœºæ™¯ 4ï¼šéžå”¯ä¸€ç´¢å¼•ç­‰å€¼æŸ¥è¯¢

```sql
SELECT * FROM t WHERE c = 10 FOR UPDATE;
```

**åŠ é”åˆ†æž**ï¼š
1. æŸ¥è¯¢ä½¿ç”¨äºŒçº§ç´¢å¼• c
2. ç­‰å€¼æŸ¥è¯¢ï¼Œæ‰¾åˆ° c = 10 çš„è®°å½•
3. å¯¹ c ç´¢å¼•åŠ  Next-Key Lock
4. ç»§ç»­å‘å³æ‰«æï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªä¸æ»¡è¶³æ¡ä»¶çš„è®°å½•
5. å¯¹ä¸»é”®ç´¢å¼•åŠ è®°å½•é”ï¼ˆå›žè¡¨ï¼‰

**åŠ é”ç»“æžœ**ï¼š
- c ç´¢å¼•ï¼š
  - (5, 10] çš„ä¸´é”®é”
  - (10, 15) çš„é—´éš™é”
- ä¸»é”®ç´¢å¼•ï¼š
  - id = 10 çš„è®°å½•é”

**ä¸ºä»€ä¹ˆè¦é” (10, 15) çš„é—´éš™ï¼Ÿ**
- é˜²æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥ c = 10 çš„æ–°è®°å½•
- ä¿è¯å¯é‡å¤è¯»

**éªŒè¯**ï¼š
```sql
-- ä¼šè¯ A
BEGIN;
SELECT * FROM t WHERE c = 10 FOR UPDATE;

-- ä¼šè¯ B
INSERT INTO t VALUES (8, 10, 10);  -- â³ é˜»å¡žï¼ˆé—´éš™é” (5, 10)ï¼‰
INSERT INTO t VALUES (12, 10, 10); -- â³ é˜»å¡žï¼ˆé—´éš™é” (10, 15)ï¼‰
UPDATE t SET d = 100 WHERE id = 10; -- â³ é˜»å¡žï¼ˆä¸»é”®è®°å½•é”ï¼‰
UPDATE t SET d = 100 WHERE c = 10;  -- â³ é˜»å¡ž
```

### åœºæ™¯ 5ï¼šéžå”¯ä¸€ç´¢å¼•èŒƒå›´æŸ¥è¯¢

```sql
SELECT * FROM t WHERE c >= 10 AND c < 15 FOR UPDATE;
```

**åŠ é”åˆ†æž**ï¼š
1. æŸ¥è¯¢ä½¿ç”¨äºŒçº§ç´¢å¼• c
2. èŒƒå›´æŸ¥è¯¢ï¼Œæ‰«æ c = 10, 15
3. å¯¹ c ç´¢å¼•åŠ  Next-Key Lock
4. å¯¹ä¸»é”®ç´¢å¼•åŠ è®°å½•é”

**åŠ é”ç»“æžœ**ï¼š
- c ç´¢å¼•ï¼š
  - (5, 10] çš„ä¸´é”®é”
  - (10, 15] çš„ä¸´é”®é”
- ä¸»é”®ç´¢å¼•ï¼š
  - id = 10, 15 çš„è®°å½•é”

### åœºæ™¯ 6ï¼šæ— ç´¢å¼•æ¡ä»¶

```sql
SELECT * FROM t WHERE d = 10 FOR UPDATE;
-- d åˆ—æ²¡æœ‰ç´¢å¼•
```

**åŠ é”åˆ†æž**ï¼š
1. å…¨è¡¨æ‰«æ
2. æ‰€æœ‰è®°å½•éƒ½åŠ  Next-Key Lock
3. **é€€åŒ–ä¸ºè¡¨é”**

**åŠ é”ç»“æžœ**ï¼š
- ä¸»é”®ç´¢å¼•ï¼šæ‰€æœ‰è®°å½•çš„ Next-Key Lock

**éªŒè¯**ï¼š
```sql
-- ä¼šè¯ A
BEGIN;
SELECT * FROM t WHERE d = 10 FOR UPDATE;

-- ä¼šè¯ B
UPDATE t SET d = 100 WHERE id = 5;  -- â³ é˜»å¡ž
UPDATE t SET d = 100 WHERE id = 20; -- â³ é˜»å¡ž
INSERT INTO t VALUES (30, 30, 30);  -- â³ é˜»å¡ž
-- æ‰€æœ‰æ“ä½œéƒ½è¢«é˜»å¡žï¼
```

**ä¼˜åŒ–å»ºè®®**ï¼š
- âœ… **å¿…é¡»ä¸º WHERE æ¡ä»¶çš„åˆ—å»ºç«‹ç´¢å¼•**
- âŒ é¿å…æ— ç´¢å¼•æ¡ä»¶çš„åŠ é”æŸ¥è¯¢

### åŠ é”è§„åˆ™é€ŸæŸ¥è¡¨

| ç´¢å¼•ç±»åž‹ | æŸ¥è¯¢ç±»åž‹ | è®°å½•æ˜¯å¦å­˜åœ¨ | åŠ é”æƒ…å†µ |
|---------|---------|------------|---------|
| å”¯ä¸€ç´¢å¼• | ç­‰å€¼æŸ¥è¯¢ | å­˜åœ¨ | è®°å½•é” |
| å”¯ä¸€ç´¢å¼• | ç­‰å€¼æŸ¥è¯¢ | ä¸å­˜åœ¨ | é—´éš™é” |
| å”¯ä¸€ç´¢å¼• | èŒƒå›´æŸ¥è¯¢ | - | ä¸´é”®é” |
| æ™®é€šç´¢å¼• | ç­‰å€¼æŸ¥è¯¢ | - | ä¸´é”®é” + é—´éš™é” |
| æ™®é€šç´¢å¼• | èŒƒå›´æŸ¥è¯¢ | - | ä¸´é”®é” |
| æ— ç´¢å¼• | ä»»ä½•æŸ¥è¯¢ | - | å…¨è¡¨é” |

---

## æ­»é”

### ä»€ä¹ˆæ˜¯æ­»é”ï¼Ÿ

æ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹åŠ¡äº’ç›¸æŒæœ‰å¯¹æ–¹éœ€è¦çš„é”ï¼Œå¯¼è‡´æ‰€æœ‰äº‹åŠ¡éƒ½æ— æ³•ç»§ç»­æ‰§è¡Œã€‚

### æ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶

1. **äº’æ–¥æ¡ä»¶**ï¼šèµ„æºä¸èƒ½è¢«å¤šä¸ªäº‹åŠ¡åŒæ—¶ä½¿ç”¨
2. **è¯·æ±‚ä¸Žä¿æŒæ¡ä»¶**ï¼šäº‹åŠ¡æŒæœ‰èµ„æºçš„åŒæ—¶è¯·æ±‚æ–°èµ„æº
3. **ä¸å¯å‰¥å¤ºæ¡ä»¶**ï¼šå·²èŽ·å¾—çš„èµ„æºä¸èƒ½è¢«å¼ºåˆ¶å‰¥å¤º
4. **å¾ªçŽ¯ç­‰å¾…æ¡ä»¶**ï¼šå­˜åœ¨å¾ªçŽ¯ç­‰å¾…é“¾

### æ­»é”æ¡ˆä¾‹ 1ï¼šç®€å•çš„ä¸¤ä¸ªäº‹åŠ¡

```sql
-- äº‹åŠ¡ A                      äº‹åŠ¡ B
BEGIN;                         BEGIN;
UPDATE t SET a=1 WHERE id=1;   
-- æŒæœ‰ id=1 çš„ X é”
                               UPDATE t SET a=2 WHERE id=2;
                               -- æŒæœ‰ id=2 çš„ X é”
UPDATE t SET a=3 WHERE id=2;
-- â³ ç­‰å¾… id=2 çš„ X é”
                               UPDATE t SET a=4 WHERE id=1;
                               -- â³ ç­‰å¾… id=1 çš„ X é”
-- ðŸ’¥ æ­»é”ï¼
```

**æ­»é”å›¾ç¤º**ï¼š
```
äº‹åŠ¡ A â†’ æŒæœ‰ id=1ï¼Œç­‰å¾… id=2
            â†“
äº‹åŠ¡ B â†’ æŒæœ‰ id=2ï¼Œç­‰å¾… id=1
            â†“
           å¾ªçŽ¯ç­‰å¾…
```

### æ­»é”æ¡ˆä¾‹ 2ï¼šé—´éš™é”ä¸Žæ’å…¥æ„å‘é”

```sql
-- å‡è®¾è¡¨ä¸­åªæœ‰ id = 5 å’Œ id = 10

-- äº‹åŠ¡ A                           äº‹åŠ¡ B
BEGIN;                              BEGIN;
SELECT * FROM t WHERE id = 7 
FOR UPDATE;
-- åŠ é—´éš™é” (5, 10)
                                    SELECT * FROM t WHERE id = 8 
                                    FOR UPDATE;
                                    -- åŠ é—´éš™é” (5, 10)
                                    -- âœ… æˆåŠŸï¼ˆé—´éš™é”ä¸äº’æ–¥ï¼‰
INSERT INTO t VALUES (7, ...);
-- ç”³è¯·æ’å…¥æ„å‘é”
-- â³ ç­‰å¾…äº‹åŠ¡ B é‡Šæ”¾é—´éš™é”
                                    INSERT INTO t VALUES (8, ...);
                                    -- ç”³è¯·æ’å…¥æ„å‘é”
                                    -- â³ ç­‰å¾…äº‹åŠ¡ A é‡Šæ”¾é—´éš™é”
-- ðŸ’¥ æ­»é”ï¼
```

**åŽŸå› **ï¼š
- é—´éš™é”ä¹‹é—´ä¸äº’æ–¥
- ä½†æ’å…¥æ„å‘é”ä¼šè¢«é—´éš™é”é˜»å¡ž
- ä¸¤ä¸ªäº‹åŠ¡éƒ½æŒæœ‰é—´éš™é”ï¼Œéƒ½æƒ³æ’å…¥ï¼Œå½¢æˆå¾ªçŽ¯ç­‰å¾…

### æ­»é”æ£€æµ‹ä¸Žå¤„ç†

#### 1. æ­»é”æ£€æµ‹

**å‚æ•°**ï¼š`innodb_deadlock_detect`
```sql
-- æŸ¥çœ‹æ­»é”æ£€æµ‹æ˜¯å¦å¼€å¯ï¼ˆé»˜è®¤å¼€å¯ï¼‰
SHOW VARIABLES LIKE 'innodb_deadlock_detect';
-- ONï¼šå¼€å¯ï¼ŒOFFï¼šå…³é—­
```

**æ£€æµ‹æœºåˆ¶**ï¼š
- InnoDB æœ‰ä¸“é—¨çš„æ­»é”æ£€æµ‹çº¿ç¨‹
- å½“äº‹åŠ¡ç­‰å¾…é”æ—¶ï¼Œæ£€æµ‹æ˜¯å¦å½¢æˆå¾ªçŽ¯ç­‰å¾…
- æ—¶é—´å¤æ‚åº¦ï¼šO(n)ï¼Œn æ˜¯äº‹åŠ¡æ•°

**é«˜å¹¶å‘ä¸‹çš„é—®é¢˜**ï¼š
- æ­»é”æ£€æµ‹æœ¬èº«æ¶ˆè€— CPU
- 1000 ä¸ªå¹¶å‘äº‹åŠ¡ï¼Œæ£€æµ‹ä¸€æ¬¡éœ€è¦ 100 ä¸‡æ¬¡è®¡ç®—
- å¯èƒ½å¯¼è‡´ CPU ä½¿ç”¨çŽ‡é£™å‡

#### 2. è¶…æ—¶æœºåˆ¶

**å‚æ•°**ï¼š`innodb_lock_wait_timeout`
```sql
-- æŸ¥çœ‹é”ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ 50 ç§’ï¼‰
SHOW VARIABLES LIKE 'innodb_lock_wait_timeout';
```

**æœºåˆ¶**ï¼š
- å¦‚æžœç­‰å¾…é”çš„æ—¶é—´è¶…è¿‡è®¾ç½®å€¼ï¼Œäº‹åŠ¡å›žæ»š
- ä¸å¤Ÿæ™ºèƒ½ï¼ˆå¯èƒ½å›žæ»šäº†é‡è¦çš„äº‹åŠ¡ï¼‰

#### 3. æ­»é”å¤„ç†ç­–ç•¥

**InnoDB çš„å¤„ç†**ï¼š
1. æ£€æµ‹åˆ°æ­»é”
2. é€‰æ‹©å›žæ»šä»£ä»·æœ€å°çš„äº‹åŠ¡
3. å›žæ»šæ•´ä¸ªäº‹åŠ¡
4. é‡Šæ”¾è¯¥äº‹åŠ¡æŒæœ‰çš„æ‰€æœ‰é”
5. å…¶ä»–äº‹åŠ¡ç»§ç»­æ‰§è¡Œ

**å›žæ»šä»£ä»·è®¡ç®—**ï¼š
- æŒæœ‰è¡Œçº§å†™é”æœ€å°‘çš„äº‹åŠ¡
- äº‹åŠ¡æƒé‡ï¼ˆå¯é€šè¿‡ `innodb_trx.trx_weight` æŸ¥çœ‹ï¼‰

#### 4. æŸ¥çœ‹æ­»é”ä¿¡æ¯

```sql
-- æŸ¥çœ‹æœ€è¿‘ä¸€æ¬¡æ­»é”ä¿¡æ¯
SHOW ENGINE INNODB STATUS;
```

**æ­»é”æ—¥å¿—ç¤ºä¾‹**ï¼š
```
------------------------
LATEST DETECTED DEADLOCK
------------------------
2024-01-11 14:30:25
*** (1) TRANSACTION:
TRANSACTION 421234, ACTIVE 10 sec starting index read
mysql tables in use 1, locked 1
LOCK WAIT 3 lock struct(s), heap size 360, 2 row lock(s)
MySQL thread id 123, OS thread handle 0x7f8c8c8c8c8c, query id 456 localhost root updating
UPDATE t SET a = 1 WHERE id = 2

*** (1) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 25 page no 4 n bits 72 index PRIMARY of table `test`.`t` 
trx id 421234 lock_mode X locks rec but not gap waiting

*** (2) TRANSACTION:
TRANSACTION 421235, ACTIVE 8 sec starting index read
mysql tables in use 1, locked 1
4 lock struct(s), heap size 1136, 3 row lock(s)
MySQL thread id 124, OS thread handle 0x7f8c8c8c8c9c, query id 457 localhost root updating
UPDATE t SET a = 2 WHERE id = 1

*** (2) HOLDS THE LOCK(S):
RECORD LOCKS space id 25 page no 4 n bits 72 index PRIMARY of table `test`.`t` 
trx id 421235 lock_mode X locks rec but not gap

*** (2) WAITING FOR THIS LOCK TO BE GRANTED:
RECORD LOCKS space id 25 page no 4 n bits 72 index PRIMARY of table `test`.`t` 
trx id 421235 lock_mode X locks rec but not gap waiting

*** WE ROLL BACK TRANSACTION (1)
```

### å¦‚ä½•é¿å…æ­»é”

#### 1. æŒ‰ç›¸åŒé¡ºåºè®¿é—®èµ„æº

```sql
-- âŒ é”™è¯¯ç¤ºä¾‹ï¼šä¸åŒé¡ºåº
-- äº‹åŠ¡ A: id=1 â†’ id=2
-- äº‹åŠ¡ B: id=2 â†’ id=1

-- âœ… æ­£ç¡®ç¤ºä¾‹ï¼šç›¸åŒé¡ºåº
-- äº‹åŠ¡ A: id=1 â†’ id=2
-- äº‹åŠ¡ B: id=1 â†’ id=2
-- ç¬¬äºŒä¸ªäº‹åŠ¡ä¼šç­‰å¾…ç¬¬ä¸€ä¸ªäº‹åŠ¡å®Œæˆï¼Œä¸ä¼šæ­»é”
```

#### 2. å°½é‡ä½¿ç”¨ç´¢å¼•è®¿é—®æ•°æ®

```sql
-- âŒ é¿å…å…¨è¡¨æ‰«æ
UPDATE t SET a = 1 WHERE non_indexed_col = 10;

-- âœ… ä½¿ç”¨ç´¢å¼•
UPDATE t SET a = 1 WHERE id = 10;
```

#### 3. å‡å°äº‹åŠ¡ç²’åº¦ï¼Œç¼©çŸ­äº‹åŠ¡æ—¶é—´

```sql
-- âŒ é•¿äº‹åŠ¡
BEGIN;
UPDATE t1 ...;
UPDATE t2 ...;
-- ... å¤æ‚ä¸šåŠ¡é€»è¾‘
UPDATE t3 ...;
COMMIT;

-- âœ… æ‹†åˆ†æˆå¤šä¸ªå°äº‹åŠ¡
BEGIN;
UPDATE t1 ...;
COMMIT;

BEGIN;
UPDATE t2 ...;
COMMIT;
```

#### 4. ä½¿ç”¨è¾ƒä½Žçš„éš”ç¦»çº§åˆ«

```sql
-- RR çº§åˆ«æœ‰é—´éš™é”ï¼Œå®¹æ˜“æ­»é”
SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ;

-- RC çº§åˆ«æ²¡æœ‰é—´éš™é”ï¼Œæ­»é”æ¦‚çŽ‡é™ä½Ž
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
```

#### 5. ä¸ºè¡¨æ·»åŠ åˆç†çš„ç´¢å¼•

```sql
-- é¿å…å› ä¸ºæ— ç´¢å¼•å¯¼è‡´çš„å…¨è¡¨é”
ALTER TABLE t ADD INDEX idx_col(col);
```

#### 6. é¿å…å¤§äº‹åŠ¡

```sql
-- âŒ æ‰¹é‡æ“ä½œåœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­
BEGIN;
UPDATE t SET ... WHERE id IN (1, 2, 3, ..., 10000);
COMMIT;

-- âœ… åˆ†æ‰¹å¤„ç†
for i in range(0, 10000, 100):
    BEGIN;
    UPDATE t SET ... WHERE id IN (i, i+1, ..., i+99);
    COMMIT;
```

#### 7. ä½¿ç”¨ SELECT ... FOR UPDATE è¦æ…Žé‡

```sql
-- åªåœ¨çœŸæ­£éœ€è¦åŠ é”æ—¶æ‰ä½¿ç”¨
SELECT * FROM t WHERE id = 1 FOR UPDATE;

-- å¦‚æžœåªæ˜¯è¯»å–ï¼Œä½¿ç”¨å¿«ç…§è¯»
SELECT * FROM t WHERE id = 1;
```

---

## é”çš„ç›‘æŽ§ä¸Žè¯Šæ–­

### 1. æŸ¥çœ‹å½“å‰é”ç­‰å¾…

#### MySQL 5.7

```sql
-- æŸ¥çœ‹æ­£åœ¨ç­‰å¾…çš„é”
SELECT * FROM information_schema.INNODB_LOCKS;

-- æŸ¥çœ‹é”ç­‰å¾…å…³ç³»
SELECT * FROM information_schema.INNODB_LOCK_WAITS;

-- æŸ¥çœ‹å½“å‰äº‹åŠ¡
SELECT * FROM information_schema.INNODB_TRX;
```

#### MySQL 8.0+

```sql
-- æŸ¥çœ‹æ•°æ®é”
SELECT * FROM performance_schema.data_locks;

-- æŸ¥çœ‹é”ç­‰å¾…å…³ç³»
SELECT * FROM performance_schema.data_lock_waits;

-- æŸ¥çœ‹å½“å‰äº‹åŠ¡
SELECT * FROM information_schema.INNODB_TRX;
```

### 2. æŸ¥çœ‹è¯¦ç»†çš„é”ä¿¡æ¯

```sql
-- æ‰¾å‡ºé˜»å¡žçš„ä¼šè¯
SELECT 
    r.trx_id waiting_trx_id,
    r.trx_mysql_thread_id waiting_thread,
    r.trx_query waiting_query,
    b.trx_id blocking_trx_id,
    b.trx_mysql_thread_id blocking_thread,
    b.trx_query blocking_query
FROM information_schema.INNODB_LOCK_WAITS w
INNER JOIN information_schema.INNODB_TRX b ON b.trx_id = w.blocking_trx_id
INNER JOIN information_schema.INNODB_TRX r ON r.trx_id = w.requesting_trx_id;
```

### 3. åˆ†æžé”ç­‰å¾…æ—¶é—´

```sql
-- æŸ¥çœ‹é•¿æ—¶é—´ç­‰å¾…é”çš„äº‹åŠ¡
SELECT 
    trx_id,
    trx_state,
    trx_started,
    trx_wait_started,
    TIMESTAMPDIFF(SECOND, trx_wait_started, NOW()) AS wait_seconds,
    trx_mysql_thread_id,
    trx_query
FROM information_schema.INNODB_TRX
WHERE trx_state = 'LOCK WAIT'
ORDER BY wait_seconds DESC;
```

### 4. æ€æ­»é˜»å¡žçš„ä¼šè¯

```sql
-- æŸ¥æ‰¾é˜»å¡žçš„çº¿ç¨‹ ID
SELECT blocking_thread FROM ...;

-- æ€æ­»çº¿ç¨‹
KILL 123;  -- 123 æ˜¯ thread_id
```

---

## é¢è¯•é«˜é¢‘é—®é¢˜

### Q1: MySQL æœ‰å“ªäº›é”ï¼Ÿ

**å›žç­”è¦ç‚¹**ï¼š

**æŒ‰ç²’åº¦åˆ†**ï¼š
- å…¨å±€é”ï¼šFLUSH TABLES WITH READ LOCK
- è¡¨çº§é”ï¼šè¡¨é”ã€MDLã€æ„å‘é”ã€AUTO-INC é”
- è¡Œçº§é”ï¼šè®°å½•é”ã€é—´éš™é”ã€ä¸´é”®é”

**æŒ‰æ¨¡å¼åˆ†**ï¼š
- å…±äº«é”ï¼ˆS é”ï¼‰ï¼šLOCK IN SHARE MODE / FOR SHARE
- æŽ’ä»–é”ï¼ˆX é”ï¼‰ï¼šFOR UPDATE

**æŒ‰ç®—æ³•åˆ†**ï¼ˆInnoDB è¡Œé”ï¼‰ï¼š
- è®°å½•é”ï¼šé”å•ä¸ªç´¢å¼•è®°å½•
- é—´éš™é”ï¼šé”ç´¢å¼•è®°å½•ä¹‹é—´çš„é—´éš™
- ä¸´é”®é”ï¼šè®°å½•é” + é—´éš™é”ï¼Œå·¦å¼€å³é—­åŒºé—´

### Q2: ä»€ä¹ˆæ˜¯é—´éš™é”å’Œä¸´é”®é”ï¼Ÿ

**é—´éš™é”ï¼ˆGap Lockï¼‰**ï¼š
- é”å®šç´¢å¼•è®°å½•ä¹‹é—´çš„"é—´éš™"
- é˜²æ­¢å…¶ä»–äº‹åŠ¡åœ¨é—´éš™ä¸­æ’å…¥æ•°æ®
- **é˜²æ­¢å¹»è¯»**
- åªåœ¨ RR éš”ç¦»çº§åˆ«ä¸‹æœ‰æ•ˆ
- é—´éš™é”ä¹‹é—´ä¸äº’æ–¥

**ä¸´é”®é”ï¼ˆNext-Key Lockï¼‰**ï¼š
- è®°å½•é” + é—´éš™é”
- é”å®šä¸€ä¸ªå·¦å¼€å³é—­åŒºé—´ (a, b]
- InnoDB çš„é»˜è®¤è¡Œé”ç®—æ³•
- **å½»åº•è§£å†³å¹»è¯»é—®é¢˜**

**ç¤ºä¾‹**ï¼š
```sql
-- è¡¨ä¸­æœ‰ï¼šid = 1, 5, 10
SELECT * FROM t WHERE id = 7 FOR UPDATE;
-- é—´éš™é”ï¼š(5, 10)

SELECT * FROM t WHERE id >= 5 AND id < 10 FOR UPDATE;
-- ä¸´é”®é”ï¼š(1, 5], (5, 10)
```

### Q3: ä¸åŒ SQL è¯­å¥å¦‚ä½•åŠ é”ï¼Ÿ

**å”¯ä¸€ç´¢å¼•ç­‰å€¼æŸ¥è¯¢**ï¼š
```sql
-- è®°å½•å­˜åœ¨
SELECT * FROM t WHERE id = 10 FOR UPDATE;
-- åŠ é”ï¼šè®°å½•é”

-- è®°å½•ä¸å­˜åœ¨
SELECT * FROM t WHERE id = 7 FOR UPDATE;
-- åŠ é”ï¼šé—´éš™é”
```

**å”¯ä¸€ç´¢å¼•èŒƒå›´æŸ¥è¯¢**ï¼š
```sql
SELECT * FROM t WHERE id >= 10 AND id < 20 FOR UPDATE;
-- åŠ é”ï¼šä¸´é”®é”
```

**éžå”¯ä¸€ç´¢å¼•æŸ¥è¯¢**ï¼š
```sql
SELECT * FROM t WHERE col = 10 FOR UPDATE;
-- åŠ é”ï¼šä¸´é”®é” + é—´éš™é” + ä¸»é”®è®°å½•é”
```

**æ— ç´¢å¼•æŸ¥è¯¢**ï¼š
```sql
SELECT * FROM t WHERE non_indexed = 10 FOR UPDATE;
-- åŠ é”ï¼šå…¨è¡¨é”ï¼ˆæ‰€æœ‰è®°å½•çš„ä¸´é”®é”ï¼‰
```

### Q4: å¦‚ä½•é¿å…æ­»é”ï¼Ÿ

**7 ä¸ªæ–¹æ³•**ï¼š
1. **æŒ‰ç›¸åŒé¡ºåºè®¿é—®èµ„æº**
2. **å°½é‡ä½¿ç”¨ç´¢å¼•**ï¼ˆé¿å…å…¨è¡¨é”ï¼‰
3. **å‡å°äº‹åŠ¡ç²’åº¦**ï¼ˆç¼©çŸ­æŒé”æ—¶é—´ï¼‰
4. **ä½¿ç”¨è¾ƒä½Žçš„éš”ç¦»çº§åˆ«**ï¼ˆRC æ²¡æœ‰é—´éš™é”ï¼‰
5. **åˆç†è®¾è®¡ç´¢å¼•**
6. **é¿å…å¤§äº‹åŠ¡**ï¼ˆåˆ†æ‰¹å¤„ç†ï¼‰
7. **æ…Žç”¨ FOR UPDATE**

### Q5: ä¸ºä»€ä¹ˆ InnoDB çš„é”æ˜¯åŠ åœ¨ç´¢å¼•ä¸Šçš„ï¼Ÿ

**åŽŸå› **ï¼š
1. **æ•ˆçŽ‡**ï¼šé€šè¿‡ç´¢å¼•å¿«é€Ÿå®šä½æ•°æ®
2. **ä¸€è‡´æ€§**ï¼šç´¢å¼•æ˜¯æœ‰åºçš„ï¼Œä¾¿äºŽèŒƒå›´é”å®š
3. **è®¾è®¡**ï¼šInnoDB çš„æ•°æ®æ˜¯æŒ‰ç´¢å¼•ç»„ç»‡çš„

**åŽæžœ**ï¼š
- æ²¡æœ‰ç´¢å¼• â†’ å…¨è¡¨æ‰«æ â†’ é”å…¨è¡¨
- æœ‰ç´¢å¼• â†’ å¿«é€Ÿå®šä½ â†’ åªé”éƒ¨åˆ†è¡Œ

**ç¤ºä¾‹**ï¼š
```sql
-- æœ‰ç´¢å¼•
UPDATE t SET a = 1 WHERE id = 10;
-- åªé” id = 10 è¿™ä¸€è¡Œ

-- æ— ç´¢å¼•
UPDATE t SET a = 1 WHERE col = 10;
-- å…¨è¡¨æ‰«æï¼Œé”æ‰€æœ‰è¡Œï¼
```

### Q6: æ„å‘é”çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

**ä½œç”¨**ï¼šåè°ƒè¡¨é”å’Œè¡Œé”çš„å†²çªï¼Œæé«˜åŠ è¡¨é”çš„æ•ˆçŽ‡ã€‚

**æ²¡æœ‰æ„å‘é”æ—¶**ï¼š
```
åŠ è¡¨é”éœ€è¦ï¼š
1. éåŽ†æ‰€æœ‰è¡Œ
2. æ£€æŸ¥æ˜¯å¦æœ‰è¡Œé”
3. O(n) å¤æ‚åº¦
```

**æœ‰æ„å‘é”æ—¶**ï¼š
```
åŠ è¡¨é”åªéœ€ï¼š
1. æ£€æŸ¥è¡¨çº§æ„å‘é”
2. O(1) å¤æ‚åº¦
```

**æœºåˆ¶**ï¼š
```sql
-- åŠ è¡Œé”æ—¶ï¼Œå…ˆåŠ è¡¨çº§æ„å‘é”
SELECT * FROM t WHERE id = 1 FOR UPDATE;
-- è‡ªåŠ¨åŠ ï¼šè¡¨çº§ IX é” â†’ è¡Œçº§ X é”

-- åŠ è¡¨é”æ—¶ï¼Œæ£€æŸ¥æ„å‘é”
LOCK TABLES t WRITE;
-- æ£€æŸ¥æ˜¯å¦æœ‰ IS æˆ– IX é”
```

### Q7: RC å’Œ RR éš”ç¦»çº§åˆ«çš„é”æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**READ COMMITTEDï¼ˆRCï¼‰**ï¼š
- âœ… æ²¡æœ‰é—´éš™é”
- âœ… åªæœ‰è®°å½•é”
- âœ… å¹¶å‘æ€§èƒ½æ›´å¥½
- âŒ æœ‰ä¸å¯é‡å¤è¯»å’Œå¹»è¯»é—®é¢˜

**REPEATABLE READï¼ˆRRï¼‰**ï¼š
- âœ… æœ‰é—´éš™é”å’Œä¸´é”®é”
- âœ… é˜²æ­¢å¹»è¯»
- âœ… ä¿è¯å¯é‡å¤è¯»
- âŒ å¹¶å‘æ€§èƒ½ç›¸å¯¹è¾ƒå·®
- âŒ æ›´å®¹æ˜“æ­»é”ï¼ˆé—´éš™é”å†²çªï¼‰

**ä½¿ç”¨å»ºè®®**ï¼š
- å¤§å¤šæ•°åœºæ™¯ï¼šRC æ›´å¥½ï¼ˆæ€§èƒ½ + æ­»é”å°‘ï¼‰
- éœ€è¦å¯é‡å¤è¯»ï¼šRR

---

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **é”çš„åˆ†ç±»**ï¼š
   - ç²’åº¦ï¼šå…¨å±€é”ã€è¡¨é”ã€è¡Œé”
   - æ¨¡å¼ï¼šå…±äº«é”(S)ã€æŽ’ä»–é”(X)
   - ç®—æ³•ï¼šè®°å½•é”ã€é—´éš™é”ã€ä¸´é”®é”

2. **è¡Œé”çš„æœ¬è´¨**ï¼š
   - é”åŠ åœ¨**ç´¢å¼•**ä¸Š
   - æ²¡æœ‰ç´¢å¼• â†’ é”å…¨è¡¨

3. **ä¸´é”®é”**ï¼š
   - è®°å½•é” + é—´éš™é”
   - å·¦å¼€å³é—­åŒºé—´ (a, b]
   - é˜²æ­¢å¹»è¯»çš„å…³é”®

4. **åŠ é”è§„åˆ™**ï¼š
   - åŸºæœ¬å•ä½ï¼šä¸´é”®é”
   - ä¸¤ä¸ªä¼˜åŒ–ï¼šé€€åŒ–ä¸ºè®°å½•é”æˆ–é—´éš™é”

5. **æ­»é”**ï¼š
   - å¾ªçŽ¯ç­‰å¾…
   - æŒ‰ç›¸åŒé¡ºåºè®¿é—®èµ„æº
   - å‡å°äº‹åŠ¡ç²’åº¦

### å­¦ä¹ å»ºè®®

1. **åŠ¨æ‰‹å®žéªŒ**ï¼š
   - æ­å»ºæµ‹è¯•çŽ¯å¢ƒ
   - éªŒè¯æ¯ç§åŠ é”åœºæ™¯
   - è§‚å¯Ÿé”ç­‰å¾…å’Œæ­»é”

2. **ç”»å›¾ç†è§£**ï¼š
   - ç”»å‡ºé—´éš™é”çš„åŒºé—´
   - ç”»å‡ºä¸´é”®é”çš„èŒƒå›´
   - ç”»å‡ºæ­»é”çš„å¾ªçŽ¯ç­‰å¾…å›¾

3. **åˆ†æžçœŸå®žæ¡ˆä¾‹**ï¼š
   - æŸ¥çœ‹ç”Ÿäº§çŽ¯å¢ƒçš„æ­»é”æ—¥å¿—
   - åˆ†æžæ…¢æŸ¥è¯¢æ˜¯å¦å› ä¸ºé”ç­‰å¾…
   - ä¼˜åŒ–åŠ é”ç­–ç•¥

4. **æŽŒæ¡ç›‘æŽ§å‘½ä»¤**ï¼š
   - `SHOW ENGINE INNODB STATUS`
   - `SELECT * FROM information_schema.INNODB_TRX`
   - `SELECT * FROM performance_schema.data_locks`

### è®°ä½è¿™äº›å…³é”®ç‚¹

- âœ… **é”åŠ åœ¨ç´¢å¼•ä¸Š**
- âœ… **æ²¡æœ‰ç´¢å¼•ä¼šé”å…¨è¡¨**
- âœ… **ä¸´é”®é” = è®°å½•é” + é—´éš™é”**
- âœ… **é—´éš™é”é˜²æ­¢å¹»è¯»**
- âœ… **æŒ‰ç›¸åŒé¡ºåºé¿å…æ­»é”**
- âœ… **RC çº§åˆ«æ²¡æœ‰é—´éš™é”**

---

**ä¸‹ä¸€æ­¥**ï¼šå­¦ä¹  [MySQL äº‹åŠ¡](transaction.md)ï¼Œç†è§£ ACIDã€éš”ç¦»çº§åˆ«å’Œ MVCC åŽŸç†ã€‚
